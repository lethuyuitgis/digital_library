<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Documents</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">
<nav class="navbar navbar-expand-lg navbar-dark bg-primary">
    <div class="container">
        <a class="navbar-brand" href="#">Document Manager</a>
        <div class="navbar-nav">
            <a class="nav-link" href="/documents">Documents</a>
            <a class="nav-link" href="/categories">Categories</a>
        </div>
    </div>
</nav>

<div class="container py-4">
    <h1 class="mb-4">Document List</h1>

    <!-- Filters -->
    <form th:action="@{/documents}" method="get" class="row g-2 mb-4">
        <div class="col-md-4">
            <select name="categoryId" class="form-select">
                <option value="">All Categories</option>
                <option th:each="cat : ${categories}" th:value="${cat.id}" th:text="${cat.name}" th:selected="${categoryId} == ${cat.id}"></option>
            </select>
        </div>
        <div class="col-md-4">
            <select name="cluster" class="form-select">
                <option value="">All Clusters</option>
                <option th:each="stat : ${clusterStats}" th:value="${stat.key}" th:text="'Cluster ' + ${stat.key}" th:selected="${cluster} == ${stat.key}"></option>
            </select>
        </div>
        <div class="col-md-4">
            <button type="submit" class="btn btn-primary w-100">Filter</button>
        </div>
    </form>

    <!-- Clustering -->
    <form th:action="@{/documents/cluster}" method="post" class="mb-4 d-flex gap-2">
        <input type="number" name="numClusters" value="3" min="1" class="form-control w-auto">
        <button type="submit" class="btn btn-success">Perform Clustering</button>
    </form>

    <!-- Document Table -->
    <a th:href="@{/documents/create}" class="btn btn-primary mb-4">Add Document</a>
    <div class="table-responsive">
        <table class="table table-bordered table-striped">
            <thead class="table-light">
            <tr>
                <th>Title</th>
                <th>Category</th>
                <th>Cluster</th>
                <th>Actions</th>
            </tr>
            </thead>
            <tbody>
            <tr th:each="doc : ${documents}">
                <td th:text="${doc.title}"></td>
                <td th:text="${doc.category.name}"></td>
                <td th:text="${doc.cluster != null} ? 'Cluster ' + ${doc.cluster} : 'Not Clustered'"></td>
                <td class="d-flex flex-wrap gap-2">
                    <a th:href="@{/documents/view/{id}(id=${doc.id})}" class="btn btn-sm btn-outline-dark">View</a>
                    <a th:href="@{/documents/{id}/similar(id=${doc.id}, page=0)}" class="btn btn-sm btn-outline-info ">View Similar</a>
                    <a th:href="@{/documents/edit/{id}(id=${doc.id})}" class="btn btn-sm btn-outline-primary">Edit</a>
                    <a th:href="@{/documents/delete/{id}(id=${doc.id})}" class="btn btn-sm btn-outline-danger ">Delete</a>

                </td>
            </tr>
            </tbody>
        </table>
    </div>

    <!-- Pagination Section -->
    <div class="d-flex flex-wrap justify-content-between align-items-center mt-4 gap-3" th:if="${totalPages > 1}">
        <!-- Left: Total items & Page navigation -->
        <div class="d-flex flex-wrap align-items-center gap-2">
            <div class="text-muted">Total [[${totalItems}]] items</div>

            <div class="btn-group " role="group">
                <a th:if="${currentPage > 0}"
                   th:href="@{/documents(page=${currentPage - 1}, size=${size}, categoryId=${categoryId}, cluster=${cluster})}"
                   class="btn btn-outline-primary">&lt;</a>

                <span th:each="i : ${#numbers.sequence(0, totalPages - 1)}">
                    <span class="px-1" th:if="${i == 0 || i == totalPages - 1 || (i >= currentPage - 1 && i <= currentPage + 1)}">
                        <a th:href="@{/documents(page=${i}, size=${size}, categoryId=${categoryId}, cluster=${cluster})}"
                           th:text="${i + 1}"
                           th:class="${i == currentPage} ? 'btn btn-primary' : 'btn btn-outline-primary'"></a>
                    </span>
                    <span px-2 th:if="${i == currentPage - 2 || i == currentPage + 2}">...</span>
                </span>

                <a th:if="${currentPage < totalPages - 1}"
                   th:href="@{/documents(page=${currentPage + 1}, size=${size}, categoryId=${categoryId}, cluster=${cluster})}"
                   class="btn btn-outline-primary">&gt;</a>
            </div>
        </div>

        <!-- Middle: Page size -->
        <div class="d-flex flex-wrap gap-3">
            <form method="get" th:action="@{/documents}" class="d-flex align-items-center gap-2">
                <input type="hidden" name="page" th:value="${currentPage}" />
                <input type="hidden" name="categoryId" th:value="${categoryId}" />
                <input type="hidden" name="cluster" th:value="${cluster}" />
                <select name="size" onchange="this.form.submit()" class="form-select">
                    <option th:value="5" th:selected="${size == 5}">5 / page</option>
                    <option th:value="10" th:selected="${size == 10}">10 / page</option>
                    <option th:value="20" th:selected="${size == 20}">20 / page</option>
                    <option th:value="50" th:selected="${size == 50}">50 / page</option>
                </select>
            </form>

            <!-- Right: Go to page -->
            <form method="get" th:action="@{/documents}" class="d-flex align-items-center gap-2">
                <input type="hidden" name="size" th:value="${size}" />
                <input type="hidden" name="categoryId" th:value="${categoryId}" />
                <input type="hidden" name="cluster" th:value="${cluster}" />
                <label class="form-label mb-0">Go to</label>
                <input type="number" name="page" min="1" th:max="${totalPages}" class="form-control" style="width: 80px;" />
                <button type="submit" class="btn btn-primary">Go</button>
            </form>
        </div>

    </div>

    <!-- Create Button -->


    <!-- Chart Section -->
    <div class="mt-5">
        <canvas id="clusterChart" width="400" height="200"></canvas>
        <!-- CHART.JS LIBRARY - phải ở trên -->
        <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>

        <!-- SCRIPT KHỞI TẠO BIỂU ĐỒ -->
        <script th:inline="javascript">
            /*<![CDATA[*/
            const clusterStats = /*[[${clusterStatsJson}]]*/ '{}';
            const parsedStats = JSON.parse(clusterStats);
            console.log("Cluster Stats:", clusterStats);
            // Tạo mảng labels và values đồng bộ từ cùng keys
            const entries = Object.entries(parsedStats).map(([k, v]) => ({
                label: k === "-1" ? "Not Clustered" : "Cluster " + k,
                value: v
            }));

            // Tách ra labels và values theo đúng thứ tự
            const labels = entries.map(e => e.label);
            const values = entries.map(e => e.value);

            // Màu sắc
            const backgroundColors = labels.map((_, i) => `hsl(${i * 50}, 70%, 60%)`);
            const borderColors = labels.map((_, i) => `hsl(${i * 50}, 70%, 40%)`);

            const ctx = document.getElementById('clusterChart').getContext('2d');
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Documents per Cluster',
                        data: values,
                        backgroundColor: backgroundColors,
                        borderColor: borderColors,
                        borderWidth: 1
                    }]
                },
                options: {
                    scales: {
                        y: { beginAtZero: true }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.label}: ${context.parsed.y} documents`;
                                }
                            }
                        }
                    }
                }
            });
            /*]]>*/
        </script>





    </div>
</div>

<!-- JS dependencies -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
